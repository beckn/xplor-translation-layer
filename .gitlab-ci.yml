stages:
  - build
  - deploy

.build:
  stage: build
  tags:
    - gcp
  only:
    - gcp_dev
  script:
    - echo "$xplor_json_key" >> key.json
    - cat key.json | docker login -u _json_key --password-stdin https://asia.gcr.io
    - docker build --platform=linux/amd64 --pull -t "asia-south1-docker.pkg.dev/xplor-sunbird-rc/dev-translator/xplor-ai-services-translator:$CI_COMMIT_SHORT_SHA" .
    - docker push asia-south1-docker.pkg.dev/xplor-sunbird-rc/dev-translator/xplor-ai-services-translator:$CI_COMMIT_SHORT_SHA
    - docker logout https://asia.gcr.io/dev-translator
    - docker image prune -af
    - echo "Image Tag- asia-south1-docker.pkg.dev/xplor-sunbird-rc/dev-translator/xplor-ai-services-translator:$CI_COMMIT_SHORT_SHA"

deploy:
  when: manual
  stage: deploy
  tags:
    - gcp
  only:
    - gcp_dev
  script:
    - cat $WITS_PEM_KEY >> wits.pem
    - cat $WITS_PRIV_KEY >> wits.key
    - ls -lart
    - pwd
    - cat wits.pem
    - cat wits.key
    # ## Creating Namespace
    # - kubectl apply -f namespace.yaml

    # ## Create a secret inn  namespace
    # - kubectl create secret tls tls-secret --cert=path/to/cert/file --key=path/to/key/file

    # ## Deploying 'dev-translator-backend' in Namespace
    # - sed "s/latest/${CI_COMMIT_SHORT_SHA}/g" deployment.yaml > deployment.tmp
    # - mv deployment.tmp deployment.yaml
    # - kubectl apply -f deployment.yaml
    # - echo -e "
    #   Dev Translator Backend URL:- https://translator-dev.thewitslab.com/"

    # ## Deploying 'ingress' in Namespace
    # - kubectl apply -f ingress.yaml
